---
import { codeToHtml } from 'shiki';

interface Props {
  code: string;
  lang?: string;
}

const { code, lang = 'typescript' } = Astro.props;

const highlighted = await codeToHtml(code.trim(), {
  lang,
  themes: {
    light: 'github-light',
    dark: 'github-dark',
  },
});
---

<div class="code-block" set:html={highlighted} />

<style is:global>
  .code-block pre.shiki {
    padding: 1rem;
    margin: 0;
    overflow: auto;
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
    font-family: 'Fira Code', 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.8125rem;
    line-height: 1.6;
    tab-size: 2;
  }

  .code-block code {
    font-family: inherit;
    background: transparent !important;
    display: block;
  }

  /* Remove default padding/margin on first line */
  .code-block .shiki .line:first-child {
    margin-top: 0;
    padding-top: 0;
  }

  /* Reset all backgrounds inside shiki to transparent */
  .code-block .shiki code,
  .code-block .shiki .line,
  .code-block .shiki span {
    background: transparent !important;
    background-color: transparent !important;
  }

  /* Light/dark mode switching - only apply bg to the pre element */
  .code-block pre.shiki {
    color: var(--shiki-light) !important;
    background-color: var(--shiki-light-bg) !important;
  }

  .code-block .shiki span {
    color: var(--shiki-light) !important;
  }

  @media (prefers-color-scheme: dark) {
    .code-block pre.shiki {
      color: var(--shiki-dark) !important;
      background-color: var(--shiki-dark-bg) !important;
    }

    .code-block .shiki span {
      color: var(--shiki-dark) !important;
    }
  }

  /* Override for explicit color mode classes */
  .g3p-light .code-block pre.shiki {
    color: var(--shiki-light) !important;
    background-color: var(--shiki-light-bg) !important;
  }

  .g3p-light .code-block .shiki span {
    color: var(--shiki-light) !important;
  }

  .g3p-dark .code-block pre.shiki {
    color: var(--shiki-dark) !important;
    background-color: var(--shiki-dark-bg) !important;
  }

  .g3p-dark .code-block .shiki span {
    color: var(--shiki-dark) !important;
  }
</style>
