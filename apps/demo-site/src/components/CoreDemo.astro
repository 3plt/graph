---
import { examples, exampleList } from '../examples';
import { generateCoreCode } from '../examples/codegen';

const defaultExample = examples.diamond;
const defaultCode = generateCoreCode(defaultExample);
---

<div class="demo-wrapper">
  <div class="demo-header">
    <div class="demo-info">
      <h3>Core Implementation</h3>
      <p>Using <code>@3plate/graph-core</code> package (vanilla JS)</p>
    </div>
    <div class="example-selector">
      <label for="core-example-select">Example:</label>
      <select id="core-example-select">
        {exampleList.map(key => (
          <option value={key} selected={key === 'diamond'}>{examples[key].name}</option>
        ))}
      </select>
    </div>
  </div>

  <div class="graph-container" id="core-graph-container">
    <!-- Graph will be rendered here -->
  </div>

  <div class="code-example">
    <h4>Code</h4>
    <pre id="core-code-display"><code class="language-typescript">{defaultCode}</code></pre>
  </div>
</div>

<style>
  .demo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .example-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .example-selector label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .example-selector select {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    background: var(--color-bg);
    color: var(--color-text);
    font-size: 0.875rem;
    cursor: pointer;
  }

  .graph-container {
    width: 100%;
    height: 350px;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    margin: 1rem 0;
    overflow: hidden;
  }

  .code-example h4 {
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  #core-code-display {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.8125rem;
    line-height: 1.5;
    margin: 0;
  }

  #core-code-display code {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  }
</style>

<script>
  import { graph } from '@3plate/graph-core';
  import { examples } from '../examples';
  import { generateCoreCode } from '../examples/codegen';

  let currentGraph: any = null;

  async function renderExample(exampleKey: string) {
    const container = document.getElementById('core-graph-container');
    const codeDisplay = document.getElementById('core-code-display');
    if (!container) return;

    const example = examples[exampleKey];
    if (!example) return;

    // Update code display
    if (codeDisplay) {
      codeDisplay.innerHTML = `<code class="language-typescript">${escapeHtml(generateCoreCode(example))}</code>`;
    }

    // Clear and re-render graph
    container.innerHTML = '';
    
    try {
      currentGraph = await graph({
        root: 'core-graph-container',
        nodes: example.nodes as any,
        edges: example.edges as any,
        options: example.options as any,
      });
    } catch (e) {
      console.error('Failed to render example:', e);
      container.innerHTML = '<p style="padding: 2rem; color: #ef4444;">Failed to load graph</p>';
    }
  }

  function escapeHtml(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('core-example-select') as HTMLSelectElement;
    const coreTab = document.querySelector('[data-tab="core"]');
    const corePanel = document.querySelector('[data-panel="core"]');

    if (select) {
      select.addEventListener('change', () => {
        renderExample(select.value);
      });
    }

    if (coreTab && corePanel) {
      if (corePanel.classList.contains('active')) {
        renderExample('diamond');
      }
      
      coreTab.addEventListener('click', () => {
        setTimeout(() => renderExample(select?.value || 'diamond'), 100);
      });
    }
  });
</script>
