---
import { examples, exampleList } from '../examples';
import { generateReactCode } from '../examples/codegen';
import Code from './Code.astro';
import ReactDemoComponent from './ReactDemoComponent';

const defaultExample = examples.diamond;
const defaultCode = generateReactCode(defaultExample);
---

<div class="demo-wrapper">
  <div class="demo-header">
    <div class="demo-info">
      <h3>React Implementation</h3>
      <p>Using <code>@3plate/graph-react</code> package</p>
    </div>
    <div class="demo-controls">
      <div class="control-group">
        <label for="react-example-select">Example:</label>
        <select id="react-example-select">
          {exampleList.map(key => (
            <option value={key} selected={key === 'diamond'}>{examples[key].name}</option>
          ))}
        </select>
      </div>
      <div class="control-group">
        <label for="react-color-mode">Theme:</label>
        <select id="react-color-mode" data-color-mode-select>
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>
  </div>

  <div class="graph-container" id="react-graph-container">
    <ReactDemoComponent client:load example={defaultExample} colorMode="system" />
  </div>

  <div class="code-example">
    <h4>Code</h4>
    <div id="react-code-display">
      <Code code={defaultCode} lang="tsx" />
    </div>
  </div>
</div>

<style>
  .demo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .demo-controls {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .control-group label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  .control-group select {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    background: var(--color-bg);
    color: var(--color-text);
    font-size: 0.875rem;
    cursor: pointer;
  }

  .graph-container {
    width: 100%;
    height: 350px;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    margin: 1rem 0;
    overflow: hidden;
  }

  .code-example h4 {
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  #react-code-display {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.8125rem;
    line-height: 1.5;
    margin: 0;
  }

  #react-code-display code {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  }
</style>

<script>
  import { examples } from '../examples';
  import { generateReactCode } from '../examples/codegen';
  import { highlightCode } from '../utils/highlighter';
  import { getResolvedColorMode, setColorMode, onColorModeChange, syncColorModeSelects, type ColorMode } from '../utils/demoState';

  let currentExampleKey = 'diamond';
  let currentColorMode: ColorMode = 'system';

  async function renderExample(exampleKey: string, colorMode: ColorMode) {
    const container = document.getElementById('react-graph-container');
    const codeDisplay = document.getElementById('react-code-display');
    if (!container) return;

    const example = examples[exampleKey];
    if (!example) return;

    // Update code display with syntax highlighting
    if (codeDisplay) {
      const code = generateReactCode(example);
      const highlighted = await highlightCode(code, 'tsx');
      codeDisplay.innerHTML = `<div class="code-block">${highlighted}</div>`;
    }

    // Update React component by dispatching a custom event
    const event = new CustomEvent('demo-update', {
      detail: { example, colorMode: getResolvedColorMode() }
    });
    container.dispatchEvent(event);

    // Also update data attributes as fallback
    container.setAttribute('data-example-key', exampleKey);
    container.setAttribute('data-color-mode', colorMode);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('react-example-select') as HTMLSelectElement;
    const reactTab = document.querySelector('[data-tab="react"]');
    const reactPanel = document.querySelector('[data-panel="react"]');
    const colorModeSelect = document.getElementById('react-color-mode') as HTMLSelectElement;

    if (select) {
      select.addEventListener('change', () => {
        currentExampleKey = select.value;
        renderExample(currentExampleKey, currentColorMode);
      });
    }

    if (colorModeSelect) {
      colorModeSelect.addEventListener('change', () => {
        currentColorMode = colorModeSelect.value as ColorMode;
        setColorMode(currentColorMode);
        syncColorModeSelects();
        renderExample(currentExampleKey, currentColorMode);
      });
    }

    // Listen for color mode changes from other demos
    onColorModeChange(() => {
      renderExample(currentExampleKey, getResolvedColorMode() as ColorMode);
    });

    if (reactTab && reactPanel) {
      if (reactPanel.classList.contains('active')) {
        renderExample('diamond', getResolvedColorMode() as ColorMode);
      }

      reactTab.addEventListener('click', () => {
        setTimeout(() => renderExample(currentExampleKey || 'diamond', getResolvedColorMode() as ColorMode), 100);
      });
    }
  });
</script>
